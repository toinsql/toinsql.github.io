<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Munera Woke - Party Game</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* --- ESTILO GERAL --- */
        body { font-family: 'Courier New', monospace; background: #121212; color: #e0e0e0; text-align: center; padding: 20px; overflow-x: hidden; }
        h1 { color: #ffcc00; text-transform: uppercase; border-bottom: 2px solid #ffcc00; display: inline-block; padding-bottom: 5px; }
        
        .container { position: relative; max-width: 800px; margin: 0 auto; border: 4px solid #fff; padding: 20px; min-height: 400px; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; background: #121212;}
        
        /* Inputs */
        input { background: #333; border: 1px solid #ffcc00; color: #fff; padding: 10px; width: 80%; margin: 10px 0; font-family: inherit; text-align: center; }
        
        /* Bot√µes */
        button { background: #ffcc00; color: #000; border: none; padding: 15px 30px; font-size: 1.2rem; cursor: pointer; font-weight: bold; margin-top: 20px; font-family: inherit; transition: 0.2s; }
        button:hover { background: #e6b800; transform: scale(1.05); }
        button:disabled { background: #444; color: #888; cursor: not-allowed; transform: none; border: 1px solid #555; }

        .btn-ready { background: #444; color: #fff; border: 2px solid #ffcc00; }
        .btn-ready.is-ready { background: #00ff00; color: #000; border-color: #00ff00; }

        .hidden { display: none !important; }
        
        /* Textos */
        .woke-phrase { font-style: italic; color: #888; margin-bottom: 30px; }
        .theme-display { color: #00ffea; font-size: 1.2rem; border: 1px dashed #00ffea; padding: 10px; margin-bottom: 20px; }

        /* Lista de Jogadores */
        .player-list { list-style: none; padding: 0; width: 100%; margin-top: 20px; }
        .player-list li { 
            background: #222; margin: 5px; padding: 15px; border: 1px dashed #555; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .status-icon { font-size: 1.5rem; }
        
        /* Batalha */
        .battle-area { font-size: 1.5rem; margin: 20px 0; }
        .vs { color: #ff0000; font-weight: bold; font-size: 2rem; margin: 10px 0; }
        
        /* Resposta da IA */
        .reason { 
            font-size: 1.4rem; color: #ffffff; font-weight: bold; line-height: 1.5; margin-top: 20px; 
            border: 2px solid #ffcc00; background-color: rgba(0, 0, 0, 0.8); padding: 20px; 
            text-align: left; border-radius: 10px; text-shadow: 1px 1px 2px black;
        }

        /* Lobby Header */
        .lobby-header { width: 100%; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px;}
        .room-name-display { font-size: 2rem; color: #fff; text-transform: uppercase; margin: 0; }

        /* Switch de Contexto */
        .context-switch { margin: 15px 0; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .switch-label { font-size: 0.9rem; color: #aaa; }
        input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }

        /* --- CAMADA DE REA√á√ïES --- */
        #reaction-layer {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            pointer-events: none; z-index: 9999; overflow: hidden;
        }

        .flying-tomato {
            position: absolute; 
            /* Tamanho grande para cobrir boa parte da tela */
            width: 80vw; 
            height: 80vh; 
            object-fit: contain;
            animation: splatAnim 3s forwards;
            pointer-events: none;
        }

        .flying-fire {
            position: absolute; font-size: 3rem;
            animation: floatUp 2s forwards;
        }

        @keyframes splatAnim {
            0% { transform: scale(0.5); opacity: 0; }
            10% { transform: scale(1.2); opacity: 1; }
            20% { transform: scale(1); }
            80% { opacity: 1; }
            100% { opacity: 0; transform: translateY(50px); }
        }

        @keyframes floatUp {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            20% { opacity: 1; transform: translateY(-20px) scale(1.2); }
            100% { transform: translateY(-200px) scale(1); opacity: 0; }
        }

        /* Controles do Espectador */
        #spectator-controls {
            position: fixed; 
            top: 50%; 
            left: 20px; /* Canto esquerdo */
            transform: translateY(-50%); /* Centraliza verticalmente */
            background: rgba(0,0,0,0.8); 
            padding: 20px 10px; 
            border-radius: 20px;
            border: 2px solid #444; 
            display: flex; 
            flex-direction: column; /* Bot√µes um embaixo do outro */
            gap: 15px; 
            z-index: 100;
        }
        .reaction-btn {
            background: none; border: none; font-size: 2rem; cursor: pointer; transition: 0.2s;
        }
        .reaction-btn:hover { transform: scale(1.3); }

    </style>
</head>
<body>

    <audio id="sfx-ding" src="https://www.soundjay.com/buttons/sounds/button-30.mp3"></audio>
    <audio id="sfx-start" src="https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3"></audio>
    <audio id="sfx-win" src="https://www.soundjay.com/misc/sounds/magic-chime-01.mp3"></audio>

    <div id="reaction-layer"></div>

    <h1>Munera Woke</h1>
    
    <div class="container">
        
        <div id="screen-menu">
            <p class="woke-phrase">"Cancelando CPFs e opini√µes desde 2025."</p>
            <input type="text" id="my-name-input" placeholder="Seu Nickname" maxlength="15" oninput="validateName()">
            <br>
            <button id="btn-create" onclick="setupHost()" disabled>CRIAR SALA (HOST)</button>
            <br><br>
            <p id="client-status" style="color: #888; font-size: 0.9rem;">(Aguardando Link...)</p>
        </div>

        <div id="screen-lobby" class="hidden">
            <div class="lobby-header">
                <input type="text" id="room-name-input" class="hidden" placeholder="Nome da Sala" value="MUNERA WOKE" oninput="updateRoomName()">
                <h2 id="room-name-text" class="room-name-display">MUNERA WOKE</h2>
            </div>

            <div id="host-link-area" class="hidden">
                <p style="font-size: 0.8rem; color: #888;">LINK DA SALA:</p>
                <input type="text" id="share-link" readonly onclick="this.select()" style="font-size: 0.8rem; padding: 5px; width: 60%;">
                
                <div class="context-switch">
                    <input type="checkbox" id="context-toggle">
                    <span class="switch-label">Ativar Modo Temas (Contexto)</span>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <button id="btn-toggle-ready" class="btn-ready" onclick="toggleReady()">N√ÉO ESTOU PRONTO</button>
            </div>

            <ul id="players-ul" class="player-list"></ul>
            
            <div id="host-start-area" class="hidden">
                <p id="ready-count" style="font-size: 0.8rem; color: #aaa;">0/0 Prontos</p>
                <button id="btn-start" onclick="startGame()" disabled>INICIAR TORNEIO</button>
            </div>
            
            <p id="msg-waiting-host" class="hidden" style="margin-top: 20px;">Esperando o Host iniciar...</p>
        </div>

        <div id="screen-input" class="hidden">
            <h2>Hora da Convoca√ß√£o</h2>
            
            <div id="theme-area" class="hidden">
                <p>TEMA DA RODADA:</p>
                <div id="theme-text" class="theme-display">...</div>
            </div>

            <p>O que voc√™ vai invocar?</p>
            <input type="text" id="creation-input" placeholder="Ex: Um Capivara de Terno" maxlength="50">
            <button onclick="submitCreation()">ENVIAR</button>
            <p id="input-status"></p>
        </div>

        <div id="screen-battle" class="hidden">
            <h2>‚öîÔ∏è BATALHA ‚öîÔ∏è</h2>
            <div class="battle-area">
                <div id="p1-name">Jogador 1</div>
                <div style="font-size: 0.8em; color: #ffcc00;" id="p1-creation">Cria√ß√£o 1</div>
                <div class="vs">VS</div>
                <div id="p2-name">Jogador 2</div>
                <div style="font-size: 0.8em; color: #ffcc00;" id="p2-creation">Cria√ß√£o 2</div>
            </div>
            <div id="loading-ai" class="hidden">ü§ñ A IA est√° julgando...</div>
            <div id="battle-result" class="hidden">
                <h3 style="color: #00ff00;">VENCEDOR: <span id="winner-name"></span></h3>
                <div class="reason" id="ai-reason"></div>
                <br>
                <button id="next-btn" class="hidden" onclick="nextBattle()">PR√ìXIMA BATALHA</button>
            </div>
        </div>
        
        <div id="screen-champion" class="hidden">
            <h1 style="color: gold;">üèÜ CAMPE√ÉO üèÜ</h1>
            <h2 id="final-winner">Nome</h2>
            <p>A cria√ß√£o suprema:</p>
            <h3 id="final-creation" style="color: #ffcc00;">Coisa</h3>
            <button onclick="location.reload()">VOLTAR AO MENU</button>
        </div>
    </div>

    <div id="spectator-controls" class="hidden">
        <button class="reaction-btn" onclick="sendReaction('tomato')">üçÖ</button>
        <button class="reaction-btn" onclick="sendReaction('fire')">üî•</button>
        <span style="color: #fff; font-size: 0.8rem; align-self: center;">Espectador</span>
    </div>

    <script>
        // ======================================================
        // üëáüëáüëá COLOQUE SUA API KEY DA GROQ AQUI üëáüëáüëá
        const GROQ_API_KEY = "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"; 
        // ======================================================

        const peer = new Peer();
        let myId = null;
        let myName = "An√¥nimo";
        let hostConn = null; 
        let connections = []; 
        let isHost = false;
        let roomName = "MUNERA WOKE";
        let isReady = false;

        // Estado do Jogo
        let players = []; 
        let battleQueue = [];
        let currentRound = [];
        
        // Novas Vari√°veis
        let currentTheme = null; // Se null, sem tema
        let isSpectator = false;

        // Lista de Temas
        const THEMES = [
            "S√≥ vale coisas c√¥micas",
            "S√≥ vale pessoas reais",
            "S√≥ vale personagens fict√≠cios",
            "S√≥ vale se voc√™ beijaria isso",
            "S√≥ vale criminosos",
            "S√≥ vale a√ß√µes"
        ];

        // URLs dos GIFs de Tomate (Links diretos para GIFs do Tenor/Imgur funcionam melhor)
        const TOMATO_GIFS = [
            "https://tenor.com/pt-BR/view/tomato-splat-tomato-throw-throwing-tomato-gif-11723082084989714691",
            "https://tenor.com/pt-BR/view/tomato-throwing-tomatoes-tomato-throw-gif-2488179709724064707"
        ];

        function playSound(id) {
            const audio = document.getElementById('sfx-' + id);
            if(audio) {
                audio.currentTime = 0;
                audio.play().catch(e => console.log("Audio block:", e));
            }
        }

        const screens = ['menu', 'lobby', 'input', 'battle', 'champion'];
        function showScreen(name) {
            screens.forEach(s => document.getElementById('screen-'+s).classList.add('hidden'));
            document.getElementById('screen-'+name).classList.remove('hidden');
        }

        function validateName() {
            const name = document.getElementById('my-name-input').value.trim();
            const btn = document.getElementById('btn-create');
            if (name.length > 0) {
                btn.disabled = false;
                myName = name;
            } else {
                btn.disabled = true;
            }
        }

        // --- PEER JS SETUP ---
        const urlParams = new URLSearchParams(window.location.search);
        const targetHostId = urlParams.get('id');

        peer.on('open', (id) => {
            myId = id;
            if (targetHostId) {
                document.getElementById('client-status').innerText = "Link detectado! Digite seu nome para entrar.";
                const btn = document.getElementById('btn-create');
                btn.innerText = "ENTRAR NA SALA";
                btn.onclick = () => joinGame(targetHostId);
            }
        });

        // --- HOST ---
        function setupHost() {
            if (!myName) return alert("Digite um nome!");
            isHost = true;
            showScreen('lobby');
            
            document.getElementById('host-link-area').classList.remove('hidden');
            document.getElementById('host-start-area').classList.remove('hidden');
            document.getElementById('share-link').value = window.location.href.split('?')[0] + '?id=' + myId;
            document.getElementById('room-name-input').classList.remove('hidden');
            document.getElementById('room-name-text').classList.add('hidden');

            players.push({ id: myId, name: myName, creation: "", isReady: false });
            updateLobbyUI();

            peer.on('connection', (conn) => {
                connections.push(conn);
                conn.on('open', () => {
                    playSound('ding');
                    conn.send({ type: 'UPDATE_ROOM_NAME', name: roomName });
                });
                conn.on('data', (data) => handleDataFromClient(data, conn.peer));
            });
        }

        function updateRoomName() {
            if(!isHost) return;
            roomName = document.getElementById('room-name-input').value;
            broadcast({ type: 'UPDATE_ROOM_NAME', name: roomName });
        }

        function startGame() {
            if (GROQ_API_KEY.includes("COLE_SUA_CHAVE")) { alert("Configure a API Key!"); return; }
            if (players.length < 2) { alert("Precisa de pelo menos 2 jogadores!"); return; }
            
            const notReady = players.filter(p => !p.isReady);
            if (notReady.length > 0) { alert("Todos precisam clicar em 'ESTOU PRONTO'!"); return; }

            // L√≥gica de Tema
            const useTheme = document.getElementById('context-toggle').checked;
            currentTheme = useTheme ? THEMES[Math.floor(Math.random() * THEMES.length)] : null;

            broadcast({ type: 'GOTO_INPUT', theme: currentTheme });
            setupInputScreen(currentTheme);
        }

        function handleDataFromClient(data, peerId) {
            if (data.type === 'JOIN_REQUEST') {
                const newPlayer = { id: peerId, name: data.name, creation: "", isReady: false };
                if (!players.find(p => p.id === peerId)) {
                    players.push(newPlayer);
                    broadcastState();
                    playSound('ding');
                }
            }
            else if (data.type === 'TOGGLE_READY') {
                const p = players.find(p => p.id === peerId);
                if (p) {
                    p.isReady = data.isReady;
                    broadcastState();
                    playSound('ding');
                }
            }
            else if (data.type === 'SUBMIT_CREATION') {
                const p = players.find(p => p.id === peerId);
                if (p) { p.creation = data.content; checkAllSubmissions(); }
            }
            else if (data.type === 'REACTION') {
                // Re-transmite para todos (incluindo host)
                spawnReaction(data.kind);
                broadcast({ type: 'SPAWN_REACTION', kind: data.kind });
            }
        }

        function broadcastState() {
            broadcast({ type: 'UPDATE_PLAYERS', data: players });
            updateLobbyUI();
        }

        function checkAllSubmissions() {
            const pending = players.filter(p => !p.creation);
            if (pending.length === 0) {
                startTournament();
            } else {
                const msg = `${players.length - pending.length}/${players.length} enviaram...`;
                broadcast({ type: 'STATUS_UPDATE', msg: msg });
                document.getElementById('input-status').innerText = msg;
            }
        }

        // --- CLIENTE ---
        function joinGame(hostId) {
            if (!myName) return alert("Digite um nome!");
            document.getElementById('client-status').innerText = "Conectando...";
            hostConn = peer.connect(hostId);
            
            hostConn.on('open', () => {
                showScreen('lobby');
                document.getElementById('msg-waiting-host').classList.remove('hidden');
                hostConn.send({ type: 'JOIN_REQUEST', name: myName });
                playSound('ding');
            });

            hostConn.on('data', (msg) => {
                if (msg.type === 'UPDATE_PLAYERS') {
                    players = msg.data;
                    updateLobbyUI();
                } 
                else if (msg.type === 'UPDATE_ROOM_NAME') {
                    roomName = msg.name;
                    document.getElementById('room-name-text').innerText = roomName;
                }
                else if (msg.type === 'GOTO_INPUT') {
                    currentTheme = msg.theme;
                    setupInputScreen(msg.theme);
                } else if (msg.type === 'STATUS_UPDATE') {
                    document.getElementById('input-status').innerText = msg.msg;
                } else if (msg.type === 'SHOW_BATTLE') {
                    showBattleUI(msg.data);
                } else if (msg.type === 'SHOW_RESULT') {
                    showResultUI(msg.data);
                } else if (msg.type === 'SHOW_CHAMPION') {
                    showChampion(msg.p.name, msg.p.creation);
                } else if (msg.type === 'SPAWN_REACTION') {
                    spawnReaction(msg.kind);
                }
            });
        }

        function toggleReady() {
            isReady = !isReady;
            const btn = document.getElementById('btn-toggle-ready');
            if (isReady) {
                btn.innerText = "ESTOU PRONTO!";
                btn.classList.add('is-ready');
            } else {
                btn.innerText = "N√ÉO ESTOU PRONTO";
                btn.classList.remove('is-ready');
            }

            playSound('ding');

            if (isHost) {
                const me = players.find(p => p.id === myId);
                if (me) me.isReady = isReady;
                broadcastState();
            } else {
                hostConn.send({ type: 'TOGGLE_READY', isReady: isReady });
            }
        }

        function updateLobbyUI() {
            const ul = document.getElementById('players-ul');
            ul.innerHTML = "";
            let readyCount = 0;

            players.forEach(p => {
                if (p.isReady) readyCount++;
                const li = document.createElement('li');
                let displayName = p.name;
                if (p.id === myId) {
                    displayName += " (Voc√™)";
                    li.style.border = "1px solid #ffcc00"; 
                }
                const statusIcon = p.isReady ? "‚úÖ" : "‚è≥";
                const statusColor = p.isReady ? "#00ff00" : "#666";
                li.innerHTML = `<span>${displayName}</span><span class="status-icon" style="color: ${statusColor}">${statusIcon}</span>`;
                ul.appendChild(li);
            });

            if (isHost) {
                const btnStart = document.getElementById('btn-start');
                document.getElementById('ready-count').innerText = `${readyCount}/${players.length} Prontos`;
                if (players.length >= 2 && readyCount === players.length) {
                    btnStart.disabled = false;
                    btnStart.style.opacity = "1";
                    btnStart.innerText = "INICIAR TORNEIO";
                } else {
                    btnStart.disabled = true;
                    btnStart.style.opacity = "0.5";
                }
            }
        }

        function setupInputScreen(theme) {
            showScreen('input');
            const themeArea = document.getElementById('theme-area');
            const themeText = document.getElementById('theme-text');
            
            if (theme) {
                themeArea.classList.remove('hidden');
                themeText.innerText = theme;
            } else {
                themeArea.classList.add('hidden');
            }
        }

        function submitCreation() {
            const val = document.getElementById('creation-input').value;
            if (!val) return;
            document.getElementById('creation-input').disabled = true;
            document.getElementById('input-status').innerText = "Enviado! Aguardando outros...";
            
            if (isHost) {
                const p = players.find(p => p.id === myId);
                p.creation = val;
                checkAllSubmissions();
            } else {
                hostConn.send({ type: 'SUBMIT_CREATION', content: val });
            }
        }

        // --- SISTEMA DE BATALHA ---
        function startTournament() {
            currentRound = [...players];
            currentRound.sort(() => Math.random() - 0.5);
            generateBattles();
        }

        function generateBattles() {
            battleQueue = [];
            for (let i = 0; i < currentRound.length; i += 2) {
                if (i + 1 < currentRound.length) {
                    battleQueue.push({ p1: currentRound[i], p2: currentRound[i+1] });
                } else {
                    battleQueue.push({ p1: currentRound[i], p2: null });
                }
            }
            currentRound = []; 
            nextBattle();
        }

        function nextBattle() {
            if (battleQueue.length === 0) {
                if (currentRound.length === 1) {
                    const champ = currentRound[0];
                    broadcast({ type: 'SHOW_CHAMPION', p: {name: champ.name, creation: champ.creation} });
                    showChampion(champ.name, champ.creation);
                    return;
                }
                generateBattles();
                return;
            }

            const battle = battleQueue.shift();
            
            if (!battle.p2) {
                currentRound.push(battle.p1);
                nextBattle(); 
                return;
            }

            const battleData = { 
                p1: { id: battle.p1.id, name: battle.p1.name, creation: battle.p1.creation }, 
                p2: { id: battle.p2.id, name: battle.p2.name, creation: battle.p2.creation } 
            };
            broadcast({ type: 'SHOW_BATTLE', data: battleData });
            showBattleUI(battleData);
            callGroqAPI(battle.p1, battle.p2);
        }

        // --- SISTEMA DE REA√á√ïES ---
        function sendReaction(kind) {
            if (isHost) {
                spawnReaction(kind);
                broadcast({ type: 'SPAWN_REACTION', kind: kind });
            } else {
                hostConn.send({ type: 'REACTION', kind: kind });
            }
        }

        function spawnReaction(kind) {
            const container = document.getElementById('reaction-layer');
            
            if (kind === 'tomato') {
                const img = document.createElement('img');
                img.src = TOMATO_GIFS[Math.floor(Math.random() * TOMATO_GIFS.length)];
                img.className = 'flying-tomato';
                
                // Posi√ß√£o aleat√≥ria dentro de um limite seguro para n√£o sair muito da tela
                img.style.left = (Math.random() * 20) + '%'; // Varia entre 0% e 20% da esquerda (para centralizar o impacto visual)
                img.style.top = (Math.random() * 20) + '%';
                
                // Espelhar aleatoriamente horizontalmente
                if (Math.random() > 0.5) img.style.transform = 'scaleX(-1)';

                container.appendChild(img);
                // playSound('splat'); // REMOVIDO O SOM
                setTimeout(() => img.remove(), 3000);
            } 
            else if (kind === 'fire') {
                const el = document.createElement('div');
                el.innerText = "üî•";
                el.className = 'flying-fire';
                el.style.left = Math.random() * 90 + '%';
                el.style.bottom = '0px';
                container.appendChild(el);
                setTimeout(() => el.remove(), 2000);
            }
        }
        
        function titleCase(str) {
            const ignore = ['de', 'da', 'do', 'das', 'dos', 'e', 'a', 'o', 'as', 'os', 'em', 'na', 'no', 'nas', 'nos', 'para', 'por', 'com', 'um', 'uma', 'uns', 'umas'];
            return str.toLowerCase().split(' ').map((word, i) => {
                if (i === 0 || !ignore.includes(word)) {
                    return word.charAt(0).toUpperCase() + word.slice(1);
                }
                return word;
            }).join(' ');
        }

        // --- IA ---
        async function callGroqAPI(player1, player2) {
            document.getElementById('loading-ai').classList.remove('hidden');
            document.getElementById('battle-result').classList.add('hidden');
            
            const apiKey = GROQ_API_KEY;
            
            // Formatando as cria√ß√µes (Capitaliza√ß√£o)
            const c1 = titleCase(player1.creation);
            const c2 = titleCase(player2.creation);

            // PROMPT ORIGINAL (Mantido conforme pedido, sem a inje√ß√£o de tema)
            const originalPromptPersonality = `Voc√™ √© uma IA engra√ßada e sarc√°stica que decide quem vence uma batalha insana entre duas cria√ß√µes malucas dentro de um servidor no discord.
            Seja sempre imprevis√≠vel, mas mantenha o bom humor. N√£o escolha aleatoriamente: pense nos nomes e imagine quem venceria num combate maluco. O p√∫blico do Discord vai rir da sua resposta, ent√£o capricha.
            N√£o use hashtags. N√£o se prenda apenas a cria√ß√µes, humanos, animais, a√ß√µes nem nada; seja apenas criativo para imaginar um cenario onde as duas "coisas" batalham, mesmo que um seja uma a√ß√£o e o outro seja uma pessoa, por exemplo.
            N√£o seja sempre l√≥gico para o que realmente ganharia, as vezes vale mais uma piada engra√ßada do que uma batalha justa...
            Fale como se voc√™ fosse um adolescente que usa muito twitter, voc√™ √© "woke", mas n√£o seja muito esteriotipado, ainda fale normalmente mas as vezes mostre essa sua personalidade "woke".
            Fa√ßa refer√™ncias sempre que puder, ent√£o do nada cite alguma outra coisa da cria√ß√£o ou algo que se encaixe em alguma das cria√ß√µes, s√≥ seja criativo ao fazer grandes refer√™ncias engra√ßadas.
            As refer√™ncias n√£o podem ser t√£o gen√©ricas, tipo "tio chato da familia", pegue algo da internet mesmo, tipo "paulista desgra√ßado", n√£o tenha medo do cancelamento, seja sem limites, mas o mais engra√ßado poss√≠vel.
            Pegue referencias atuais de 2025 se for poss√≠vel, e n√£o seja t√£o for√ßado, n√£o precisa usar referencias o tempo todo, apenas quando for necess√°rio.
            Pense mais na piada em si com as cria√ß√µes com talvez referencias simples antes de pensar na referencia suprema, pq ela tem que ser uma referencia muito boa usada na hora certa.
            Quando algum jogador escrever algo que refira a ele mesmo, tipo "eu" ou "meu bra√ßo", se refira ao proprio jogador mesmo, falando dele, e n√£o tenha medo do zoar ou vangloriar o jogador, podendo chamar ele de fracote ou de forte pra caramba.
            Sua zueira tem que ser algo engra√ßado de forma natural, e n√£o algo super for√ßado.
            Nunca comece sua resposta com um "Porque", seja apenas natural e as vezes altere o estilo da resposta pra algo criativo e engra√ßado, falando como que tal cria√ß√£o ganhou, principalmente imaginando a situa√ß√£o da briga.
            Primeiro procure sobre o nome das cria√ß√µes pra ver se √© referencia a algo minimamente famoso, tipo Grupo Revela√ß√£o ou Turma do Pagode, pq seria legal uma resposta inspirada nas referencias originais.
            NAO USE LITERALMENTE OS EXEMPLOS DO PROMPT, S√ÉO APENAS PARA VOC√ä USAR COMO EXEMPLO E FALAR COISAS QUE S√ÉO NESSE ESTILO DE HUMOR, RESPOSTA, ETC.
            Fa√ßa piadas de humor negro quando for o momento.`;

            const userPromptContent = `As cria√ß√µes s√£o:
            üë§ "${player1.name}" (ID: 1) com: "${c1}"
            üë§ "${player2.name}" (ID: 2) com: "${c2}"
            Escolha UM vencedor e diga o motivo mais engra√ßado poss√≠vel.`;

            try {
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [
                            { role: "system", content: originalPromptPersonality + `\nResponda JSON: {"winner_id": 1 ou 2, "reason": "texto"}` },
                            { role: "user", content: userPromptContent }
                        ],
                        temperature: 0.8, max_tokens: 400, response_format: { type: "json_object" } 
                    })
                });

                const data = await response.json();
                const result = JSON.parse(data.choices[0].message.content);
                const winner = (result.winner_id == 1 || result.winner_id == "1") ? player1 : player2;
                const loserId = (winner.id === player1.id) ? player2.id : player1.id;
                
                // Formatar a cria√ß√£o vencedora tamb√©m
                const winnerCreationTitle = titleCase(winner.creation);

                currentRound.push(winner);
                
                // AQUI EST√Å A MUDAN√áA DO NOME: winnerName agora recebe a cria√ß√£o formatada
                const resData = { 
                    winnerName: winnerCreationTitle, // Mostra a CRIA√á√ÉO como vencedora
                    reason: result.reason, 
                    winnerId: winner.id, 
                    loserId: loserId 
                };
                
                broadcast({ type: 'SHOW_RESULT', data: resData });
                showResultUI(resData);

            } catch (error) {
                console.error(error);
                currentRound.push(player1); // Fallback
                const resData = { winnerName: titleCase(player1.creation), reason: "A IA explodiu. W.O.!", winnerId: player1.id, loserId: player2.id };
                broadcast({ type: 'SHOW_RESULT', data: resData });
                showResultUI(resData);
            }
        }

        // --- UI E REDE ---
        function broadcast(msg) {
            connections.forEach(c => c.send(msg));
        }

        function showBattleUI(data) {
            showScreen('battle');
            playSound('start');
            document.getElementById('p1-name').innerText = data.p1.name;
            document.getElementById('p1-creation').innerText = data.p1.creation;
            document.getElementById('p2-name').innerText = data.p2.name;
            document.getElementById('p2-creation').innerText = data.p2.creation;
            document.getElementById('loading-ai').classList.remove('hidden');
            document.getElementById('battle-result').classList.add('hidden');
            document.getElementById('next-btn').classList.add('hidden');
        }

        function showResultUI(data) {
            playSound('win');
            document.getElementById('loading-ai').classList.add('hidden');
            document.getElementById('battle-result').classList.remove('hidden');
            document.getElementById('winner-name').innerText = data.winnerName;
            document.getElementById('ai-reason').innerText = data.reason;
            
            // Verifica se eu perdi para virar espectador
            if (myId === data.loserId) {
                isSpectator = true;
                document.getElementById('spectator-controls').classList.remove('hidden');
            }

            if (isHost) document.getElementById('next-btn').classList.remove('hidden');
        }
        
        function showChampion(name, creation) {
            playSound('win');
            showScreen('champion');
            document.getElementById('final-winner').innerText = name;
            document.getElementById('final-creation').innerText = creation;
            document.getElementById('spectator-controls').classList.add('hidden'); // Esconde controles no fim
        }

    </script>
</body>
</html>
