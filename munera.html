<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Munera Woke - Party Game</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* --- ESTILO GERAL --- */
        body { font-family: 'Courier New', monospace; background: #121212; color: #e0e0e0; text-align: center; padding: 20px; overflow-x: hidden; }
        h1 { color: #ffcc00; text-transform: uppercase; border-bottom: 2px solid #ffcc00; display: inline-block; padding-bottom: 5px; }
        
        .container { position: relative; max-width: 800px; margin: 0 auto; border: 4px solid #fff; padding: 20px; min-height: 400px; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; background: #121212;}
        
        /* Inputs */
        input { background: #333; border: 1px solid #ffcc00; color: #fff; padding: 10px; width: 80%; margin: 10px 0; font-family: inherit; text-align: center; }
        
        /* Bot√µes */
        button { background: #ffcc00; color: #000; border: none; padding: 15px 30px; font-size: 1.2rem; cursor: pointer; font-weight: bold; margin-top: 20px; font-family: inherit; transition: 0.2s; }
        button:hover { background: #e6b800; transform: scale(1.05); }
        button:disabled { background: #444; color: #888; cursor: not-allowed; transform: none; border: 1px solid #555; }

        .btn-ready { background: #444; color: #fff; border: 2px solid #ffcc00; }
        .btn-ready.is-ready { background: #00ff00; color: #000; border-color: #00ff00; }
        
        .btn-secondary { background: #444; color: #fff; border: 1px solid #aaa; font-size: 1rem; padding: 10px 20px; }
        .btn-secondary:hover { background: #666; }

        .hidden { display: none !important; }
        
        /* Textos */
        .woke-phrase { font-style: italic; color: #888; margin-bottom: 30px; }
        .theme-display { color: #00ffea; font-size: 1.2rem; border: 1px dashed #00ffea; padding: 10px; margin-bottom: 20px; }

        /* Lista de Jogadores */
        .player-list { list-style: none; padding: 0; width: 100%; margin-top: 20px; }
        .player-list li { 
            background: #222; margin: 5px; padding: 15px; border: 1px dashed #555; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .status-icon { font-size: 1.5rem; }
        
        /* Batalha */
        .battle-area { font-size: 1.5rem; margin: 20px 0; }
        .vs { color: #ff0000; font-weight: bold; font-size: 2rem; margin: 10px 0; }
        
        /* Resposta da IA */
        .reason { 
            font-size: 1.4rem; color: #ffffff; font-weight: bold; line-height: 1.5; margin-top: 20px; 
            border: 2px solid #ffcc00; background-color: rgba(0, 0, 0, 0.8); padding: 20px; 
            text-align: left; border-radius: 10px; text-shadow: 1px 1px 2px black;
            min-height: 100px;
        }

        /* --- TELA DE VIT√ìRIA --- */
        .victory-title { font-size: 1.2rem; color: #aaa; text-transform: uppercase; margin-bottom: 10px; }
        .champion-name { 
            font-size: 3rem; color: #ffcc00; font-weight: bold; text-transform: uppercase; 
            word-wrap: break-word; line-height: 1.1; margin-bottom: 20px; text-shadow: 2px 2px 0px #000;
        }
        .trophy-icon { font-size: 4rem; margin: 10px 0 20px 0; }
        .speech-text { 
            font-size: 1.8rem; color: #ffffff; font-weight: bold; font-style: italic; 
            margin-top: 20px; text-shadow: 1px 1px 5px rgba(0,0,0,0.8); 
        }

        /* --- TELA DE PLACAR --- */
        .podium-area { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; align-items: flex-end; }
        .podium-place { display: flex; flex-direction: column; align-items: center; }
        .podium-rank { font-size: 2rem; font-weight: bold; }
        .podium-name { font-size: 1.2rem; color: #ffcc00; max-width: 150px; }
        .rank-1 { color: #ffd700; font-size: 2.5rem; order: 2; } /* Ouro */
        .rank-2 { color: #c0c0c0; order: 1; } /* Prata */
        .rank-3 { color: #cd7f32; order: 3; } /* Bronze */
        
        .battle-log { 
            width: 100%; text-align: left; background: #222; padding: 15px; 
            max-height: 300px; overflow-y: auto; border: 1px solid #444; margin-bottom: 20px;
        }
        .log-entry { margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; font-size: 0.9rem; word-wrap: break-word; }

        /* --- PREPARE-SE --- */
        .prepare-title { font-size: 3rem; color: #ff0000; font-weight: bold; animation: pulse 1s infinite; }
        .prepare-subtitle { font-size: 1.5rem; color: #aaa; margin-top: 10px; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* Efeito de Digita√ß√£o */
        .typing-cursor::after { content: '|'; animation: blink 1s step-start infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        /* Lobby Header */
        .lobby-header { width: 100%; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px;}
        .room-name-display { font-size: 2rem; color: #fff; text-transform: uppercase; margin: 0; }

        /* Controles do Lobby */
        .game-mode-selector { margin: 15px 0; background: #222; padding: 10px; border: 1px solid #444; display: inline-block; }
        .mode-option { margin: 0 10px; cursor: pointer; }
        .mode-option input { width: auto; margin-right: 5px; }

        /* Switch de Contexto */
        .context-switch { margin: 15px 0; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .switch-label { font-size: 0.9rem; color: #aaa; }
        input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }

        /* --- CAMADA DE REA√á√ïES --- */
        #reaction-layer {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            pointer-events: none; z-index: 9999; overflow: hidden;
        }

        .flying-tomato {
            position: absolute; 
            width: 80vw; height: 80vh; 
            object-fit: contain;
            animation: splatAnim 7s forwards; 
            pointer-events: none;
        }

        .flying-fire {
            position: absolute; font-size: 3rem;
            animation: floatUp 2s forwards;
        }

        @keyframes splatAnim {
            0% { transform: scale(0.5); opacity: 0; }
            5% { transform: scale(1.1); opacity: 1; }
            90% { transform: scale(1); opacity: 1; } 
            100% { transform: scale(1); opacity: 0; } 
        }

        @keyframes floatUp {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            20% { opacity: 1; transform: translateY(-20px) scale(1.2); }
            100% { transform: translateY(-200px) scale(1); opacity: 0; }
        }

        /* Controles do Espectador */
        #spectator-controls {
            position: fixed; top: 50%; left: 20px; transform: translateY(-50%); 
            background: rgba(0,0,0,0.8); padding: 20px 10px; border-radius: 20px;
            border: 2px solid #444; display: flex; flex-direction: column; gap: 15px; z-index: 100;
        }
        .reaction-btn {
            background: none; border: none; font-size: 2rem; cursor: pointer; transition: 0.2s;
        }
        .reaction-btn:hover { transform: scale(1.3); }

        /* --- DEBUG ERROR MODAL --- */
        #debug-error-modal {
            position: fixed; top: 10%; left: 10%; width: 80%; background: #300; border: 2px solid red; 
            color: #fff; padding: 20px; z-index: 10000; overflow: auto; max-height: 80vh;
            text-align: left; box-shadow: 0 0 20px rgba(255,0,0,0.5);
        }
        #debug-error-text {
            white-space: pre-wrap; font-family: monospace; background: #000; padding: 10px;
        }

    </style>
</head>
<body>

    <audio id="sfx-ding" src="https://www.soundjay.com/buttons/sounds/button-30.mp3"></audio>
    <audio id="sfx-start" src="https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3"></audio>
    <audio id="sfx-win" src="https://www.soundjay.com/misc/sounds/magic-chime-01.mp3"></audio>

    <div id="reaction-layer"></div>

    <div id="debug-error-modal" class="hidden">
        <h2 style="color: red; margin-top: 0;">ERRO NA API (Copie isso para o chat)</h2>
        <div id="debug-error-text"></div>
        <button onclick="document.getElementById('debug-error-modal').classList.add('hidden')" style="background: #555; margin-top: 10px;">Fechar</button>
    </div>

    <h1>Munera Woke</h1>
    
    <div class="container">
        
        <div id="screen-menu">
            <p class="woke-phrase">"Cancelando CPFs e opini√µes desde 2025."</p>
            <input type="text" id="my-name-input" placeholder="Seu Nickname" maxlength="15" oninput="validateName()">
            <br>
            <button id="btn-create" onclick="setupHost()" disabled>CRIAR SALA (HOST)</button>
            <br><br>
            <p>Ou entre numa sala:</p>
            <p id="client-status" style="color: #888; font-size: 0.9rem;">(Aguardando Link...)</p>
            <br>
            <button id="btn-back-menu" class="btn-secondary" onclick="window.location.href='testes.html'">VOLTAR PARA SELE√á√ÉO DE JOGOS</button>
        </div>

        <div id="screen-lobby" class="hidden">
            <div class="lobby-header">
                <input type="text" id="room-name-input" class="hidden" placeholder="Nome da Sala" value="MUNERA WOKE" oninput="updateRoomName()">
                <h2 id="room-name-text" class="room-name-display">MUNERA WOKE</h2>
            </div>

            <div id="host-link-area" class="hidden">
                <p style="font-size: 0.8rem; color: #888;">LINK DA SALA:</p>
                <input type="text" id="share-link" readonly onclick="this.select()" style="font-size: 0.8rem; padding: 5px; width: 60%;">
                
                <div class="game-mode-selector">
                    <label class="mode-option"><input type="radio" name="gameMode" value="quick" onclick="updateGameMode('quick')"> Batalha R√°pida (Max 2)</label>
                    <label class="mode-option"><input type="radio" name="gameMode" value="tournament" checked onclick="updateGameMode('tournament')"> Torneio (Min 3)</label>
                </div>

                <div class="context-switch">
                    <input type="checkbox" id="context-toggle">
                    <span class="switch-label">Ativar Modo Temas (Contexto)</span>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <button id="btn-toggle-ready" class="btn-ready" onclick="toggleReady()">N√ÉO ESTOU PRONTO</button>
            </div>

            <ul id="players-ul" class="player-list"></ul>
            
            <div id="host-start-area" class="hidden">
                <p id="ready-count" style="font-size: 0.8rem; color: #aaa;">0/0 Prontos</p>
                <button id="btn-start" onclick="startGame()" disabled>INICIAR JOGO</button>
            </div>
            
            <p id="msg-waiting-host" class="hidden" style="margin-top: 20px;">Esperando o Host iniciar...</p>
        </div>

        <div id="screen-starting" class="hidden">
            <div class="prepare-title">Partida iniciando!</div>
            <div class="prepare-subtitle">Prepare sua massa cerebral...</div>
        </div>

        <div id="screen-input" class="hidden">
            <h2>Hora da Convoca√ß√£o</h2>
            
            <div id="theme-area" class="hidden">
                <p>TEMA DA RODADA:</p>
                <div id="theme-text" class="theme-display">...</div>
            </div>

            <p>O que voc√™ vai invocar?</p>
            <input type="text" id="creation-input" placeholder="Ex: Um Capivara de Terno" maxlength="50">
            <button onclick="submitCreation()">ENVIAR</button>
            <p id="input-status"></p>
        </div>

        <div id="screen-battle" class="hidden">
            <h2>‚öîÔ∏è BATALHA ‚öîÔ∏è</h2>
            <div class="battle-area">
                <div id="p1-name">Jogador 1</div>
                <div style="font-size: 0.8em; color: #ffcc00;" id="p1-creation">Cria√ß√£o 1</div>
                <div class="vs">VS</div>
                <div id="p2-name">Jogador 2</div>
                <div style="font-size: 0.8em; color: #ffcc00;" id="p2-creation">Cria√ß√£o 2</div>
            </div>
            <div id="loading-ai" class="hidden">ü§ñ A IA est√° julgando...</div>
            <div id="battle-result" class="hidden">
                <h3 style="color: #00ff00;">VENCEDOR: <span id="winner-name"></span></h3>
                <div class="reason typing-cursor" id="ai-reason"></div>
                <br>
                <button id="next-btn" class="hidden" onclick="nextBattle()">PR√ìXIMA BATALHA</button>
            </div>
        </div>
        
        <div id="screen-champion" class="hidden">
            <p class="victory-title">Discurso de Vit√≥ria de</p>
            <div id="final-creation" class="champion-name">...</div>
            <div class="trophy-icon">üèÜ</div>
            <div id="champion-speech" class="speech-text typing-cursor">Gerando discurso...</div>
            <br><br>
            <button id="btn-show-recap" class="hidden" onclick="hostTriggerRecap()">VER PLACAR (HOST)</button>
            <p id="msg-wait-recap" class="hidden" style="color: #aaa;">O Host est√° admirando a vit√≥ria...</p>
        </div>

        <div id="screen-recap" class="hidden">
            <h2>üèÜ PLACAR FINAL üèÜ</h2>
            
            <div class="podium-area" id="podium-area"></div>

            <button onclick="document.getElementById('battle-log-container').classList.toggle('hidden')" class="btn-secondary" style="margin-bottom: 10px; font-size: 0.8rem;">
                üìú Mostrar/Esconder Hist√≥rico Completo
            </button>
            
            <div id="battle-log-container" class="battle-log hidden"></div>

            <div style="display: flex; gap: 10px; justify-content: center;">
                <button id="btn-rematch" onclick="handleRematchClick()">JOGAR NOVAMENTE</button>
                <button id="btn-host-end" class="btn-secondary hidden" onclick="hostEndGame()">VOLTAR AO MENU (HOST)</button>
            </div>
            <p id="rematch-status" style="font-size: 0.8rem; margin-top: 5px; color: #aaa;"></p>
        </div>

        <div id="screen-host-ended" class="hidden">
            <h2>O Host encerrou o jogo.</h2>
            <p>Obrigado por jogar Munera Woke!</p>
            <button onclick="location.reload()">VOLTAR AO MENU</button>
        </div>

    </div>

    <div id="spectator-controls" class="hidden">
        <button class="reaction-btn" onclick="sendReaction('tomato')">üçÖ</button>
        <button class="reaction-btn" onclick="sendReaction('fire')">üî•</button>
        <span style="color: #fff; font-size: 0.8rem; align-self: center;">Espectador</span>
    </div>

    <script>
        // ======================================================
        // üëáüëáüëá COLOQUE SUA API KEY DO OPENROUTER AQUI üëáüëáüëá
        const OPENROUTER_API_KEY = "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"; 
        // ======================================================

        const peer = new Peer();
        let myId = null;
        let myName = "An√¥nimo";
        let hostConn = null; 
        let connections = []; 
        let isHost = false;
        let roomName = "MUNERA WOKE";
        let isReady = false;

        let players = []; 
        let battleQueue = [];
        let currentRound = [];
        let eliminatedPlayers = []; 
        let battleHistoryLog = []; 
        
        let gameMode = 'tournament'; 
        let currentTheme = null;
        let isSpectator = false;
        let rematchReadyCount = 0;

        const THEMES = [
            "S√≥ vale coisas c√¥micas",
            "S√≥ vale pessoas reais",
            "S√≥ vale personagens fict√≠cios",
            "S√≥ vale se voc√™ beijaria isso",
            "S√≥ vale criminosos",
            "S√≥ vale a√ß√µes"
        ];

        const TOMATO_GIFS = ["tomato-splat.gif"];

        function playSound(id) {
            const audio = document.getElementById('sfx-' + id);
            if(audio) {
                audio.currentTime = 0;
                audio.play().catch(e => console.log("Audio block:", e));
            }
        }

        const screens = ['menu', 'lobby', 'starting', 'input', 'battle', 'champion', 'recap', 'host-ended'];
        function showScreen(name) {
            screens.forEach(s => document.getElementById('screen-'+s).classList.add('hidden'));
            document.getElementById('screen-'+name).classList.remove('hidden');
        }

        function validateName() {
            const name = document.getElementById('my-name-input').value.trim();
            const btn = document.getElementById('btn-create');
            if (name.length > 0) btn.disabled = false; myName = name;
            if (name.length == 0) btn.disabled = true;
        }

        function showError(msg) {
            const modal = document.getElementById('debug-error-modal');
            const text = document.getElementById('debug-error-text');
            modal.classList.remove('hidden');
            text.innerText = msg;
        }

        let typingTimeout = null;
        function typeWriter(elementId, text, speed = 30) {
            const element = document.getElementById(elementId);
            element.innerHTML = "";
            element.classList.add("typing-cursor");
            let i = 0;
            if (typingTimeout) clearTimeout(typingTimeout);
            function type() {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                    typingTimeout = setTimeout(type, speed);
                } else {
                    element.classList.remove("typing-cursor");
                }
            }
            type();
        }

        // --- PEER JS SETUP ---
        const urlParams = new URLSearchParams(window.location.search);
        const targetHostId = urlParams.get('id');

        peer.on('open', (id) => {
            myId = id;
            if (targetHostId) {
                document.getElementById('client-status').innerText = "Link detectado! Digite seu nome para entrar.";
                const btn = document.getElementById('btn-create');
                btn.innerText = "ENTRAR NA SALA";
                btn.onclick = () => joinGame(targetHostId);
                
                // ESCONDE O BOT√ÉO DE VOLTAR PARA CLIENTES (Corre√ß√£o)
                document.getElementById('btn-back-menu').classList.add('hidden');
            }
        });

        // --- HOST ---
        function setupHost() {
            if (!myName) return alert("Digite um nome!");
            isHost = true;
            showScreen('lobby');
            document.getElementById('host-link-area').classList.remove('hidden');
            document.getElementById('host-start-area').classList.remove('hidden');
            document.getElementById('share-link').value = window.location.href.split('?')[0] + '?id=' + myId;
            document.getElementById('room-name-input').classList.remove('hidden');
            document.getElementById('room-name-text').classList.add('hidden');

            players.push({ id: myId, name: myName, creation: "", isReady: false });
            updateLobbyUI();

            peer.on('connection', (conn) => {
                connections.push(conn);
                conn.on('open', () => {
                    playSound('ding');
                    conn.send({ type: 'UPDATE_ROOM_NAME', name: roomName });
                    conn.send({ type: 'UPDATE_GAME_MODE', mode: gameMode });
                });
                conn.on('data', (data) => handleDataFromClient(data, conn.peer, conn));
            });
        }

        function updateRoomName() {
            if(!isHost) return;
            roomName = document.getElementById('room-name-input').value;
            broadcast({ type: 'UPDATE_ROOM_NAME', name: roomName });
        }

        function updateGameMode(mode) {
            gameMode = mode;
            broadcast({ type: 'UPDATE_GAME_MODE', mode: mode });
        }

        function startGame() {
            if (OPENROUTER_API_KEY.includes("sk-or-v1") === false) { alert("Cole sua API Key do OpenRouter correta!"); return; }
            
            if (gameMode === 'quick') {
                if (players.length > 2) { alert("Batalha R√°pida suporta no m√°ximo 2 jogadores!"); return; }
                if (players.length < 2) { alert("Precisa de 2 jogadores!"); return; }
            } else {
                if (players.length < 3) { alert("Torneio precisa de pelo menos 3 jogadores!"); return; }
            }
            
            const notReady = players.filter(p => !p.isReady);
            if (notReady.length > 0) { alert("Todos precisam clicar em 'ESTOU PRONTO'!"); return; }

            const useTheme = document.getElementById('context-toggle').checked;
            currentTheme = useTheme ? THEMES[Math.floor(Math.random() * THEMES.length)] : null;

            broadcast({ type: 'GAME_STARTING', theme: currentTheme });
            performStartSequence(currentTheme);
        }

        function performStartSequence(theme) {
            showScreen('starting');
            const delay = (gameMode === 'quick') ? 1500 : 4000;
            setTimeout(() => {
                showScreen('input');
                setupInputScreen(theme);
            }, delay);
        }

        function handleDataFromClient(data, peerId, conn) {
            if (data.type === 'JOIN_REQUEST') {
                if (players.find(p => p.name === data.name)) {
                    conn.send({ type: 'ERROR', msg: 'Nome j√° em uso nesta sala!' });
                    return;
                }
                const newPlayer = { id: peerId, name: data.name, creation: "", isReady: false };
                if (!players.find(p => p.id === peerId)) {
                    players.push(newPlayer);
                    broadcastState();
                    playSound('ding');
                }
            }
            else if (data.type === 'TOGGLE_READY') {
                const p = players.find(p => p.id === peerId);
                if (p) { p.isReady = data.isReady; broadcastState(); playSound('ding'); }
            }
            else if (data.type === 'SUBMIT_CREATION') {
                const p = players.find(p => p.id === peerId);
                if (p) { p.creation = data.content; checkAllSubmissions(); }
            }
            else if (data.type === 'REACTION') {
                spawnReaction(data.kind);
                broadcast({ type: 'SPAWN_REACTION', kind: data.kind });
            }
            else if (data.type === 'CLIENT_REMATCH') {
                handleClientRematch(peerId);
            }
        }

        function broadcastState() {
            broadcast({ type: 'UPDATE_PLAYERS', data: players });
            updateLobbyUI();
        }

        function checkAllSubmissions() {
            const pending = players.filter(p => !p.creation);
            if (pending.length === 0) {
                startTournament();
            } else {
                const msg = `${players.length - pending.length}/${players.length} enviaram...`;
                broadcast({ type: 'STATUS_UPDATE', msg: msg });
                document.getElementById('input-status').innerText = msg;
            }
        }

        // --- CLIENTE ---
        function joinGame(hostId) {
            if (!myName) return alert("Digite um nome!");
            document.getElementById('client-status').innerText = "Conectando...";
            // Esconde bot√£o de voltar se for cliente
            document.getElementById('btn-back-menu').classList.add('hidden');
            
            hostConn = peer.connect(hostId);
            
            hostConn.on('open', () => {
                showScreen('lobby');
                document.getElementById('msg-waiting-host').classList.remove('hidden');
                hostConn.send({ type: 'JOIN_REQUEST', name: myName });
                playSound('ding');
            });

            hostConn.on('data', (msg) => {
                if (msg.type === 'ERROR') {
                    alert(msg.msg);
                    location.reload();
                }
                else if (msg.type === 'UPDATE_PLAYERS') {
                    players = msg.data;
                    updateLobbyUI();
                } 
                else if (msg.type === 'UPDATE_ROOM_NAME') {
                    roomName = msg.name;
                    document.getElementById('room-name-text').innerText = roomName;
                }
                else if (msg.type === 'UPDATE_GAME_MODE') {
                    gameMode = msg.mode;
                }
                else if (msg.type === 'GAME_STARTING') {
                    currentTheme = msg.theme;
                    performStartSequence(msg.theme);
                } else if (msg.type === 'STATUS_UPDATE') {
                    document.getElementById('input-status').innerText = msg.msg;
                } else if (msg.type === 'SHOW_BATTLE') {
                    showBattleUI(msg.data);
                } else if (msg.type === 'SHOW_RESULT') {
                    showResultUI(msg.data);
                } else if (msg.type === 'SHOW_CHAMPION') {
                    showChampion(msg.p.name, msg.p.creation);
                } else if (msg.type === 'UPDATE_SPEECH') {
                    updateChampionSpeech(msg.speech);
                } else if (msg.type === 'SPAWN_REACTION') {
                    spawnReaction(msg.kind);
                } else if (msg.type === 'HOST_ENDED') {
                    showScreen('host-ended');
                } else if (msg.type === 'SHOW_RECAP') {
                    renderRecapScreen(msg.podium, msg.log);
                } else if (msg.type === 'RESET_GAME') {
                    resetLocalGame();
                }
            });
        }

        // [FUN√á√ïES DE TOGGLE READY, UPDATE LOBBY, INPUT SCREEN - MANTIDAS IGUAIS]
        function toggleReady() {
            isReady = !isReady;
            const btn = document.getElementById('btn-toggle-ready');
            if (isReady) { btn.innerText = "ESTOU PRONTO!"; btn.classList.add('is-ready'); } 
            else { btn.innerText = "N√ÉO ESTOU PRONTO"; btn.classList.remove('is-ready'); }
            playSound('ding');
            if (isHost) {
                const me = players.find(p => p.id === myId);
                if (me) me.isReady = isReady;
                broadcastState();
            } else { hostConn.send({ type: 'TOGGLE_READY', isReady: isReady }); }
        }

        function updateLobbyUI() {
            const ul = document.getElementById('players-ul');
            ul.innerHTML = "";
            let readyCount = 0;
            players.forEach(p => {
                if (p.isReady) readyCount++;
                const li = document.createElement('li');
                let displayName = p.name;
                if (p.id === myId) { displayName += " (Voc√™)"; li.style.border = "1px solid #ffcc00"; }
                const statusIcon = p.isReady ? "‚úÖ" : "‚è≥";
                const statusColor = p.isReady ? "#00ff00" : "#666";
                li.innerHTML = `<span>${displayName}</span><span class="status-icon" style="color: ${statusColor}">${statusIcon}</span>`;
                ul.appendChild(li);
            });
            if (isHost) {
                const btnStart = document.getElementById('btn-start');
                document.getElementById('ready-count').innerText = `${readyCount}/${players.length} Prontos`;
                if (players.length >= 2 && readyCount === players.length) {
                    btnStart.disabled = false; btnStart.style.opacity = "1"; btnStart.innerText = "INICIAR JOGO";
                } else {
                    btnStart.disabled = true; btnStart.style.opacity = "0.5";
                }
            }
        }

        function setupInputScreen(theme) {
            const themeArea = document.getElementById('theme-area');
            const themeText = document.getElementById('theme-text');
            if (theme) { themeArea.classList.remove('hidden'); themeText.innerText = theme; } 
            else { themeArea.classList.add('hidden'); }
        }

        function submitCreation() {
            const val = document.getElementById('creation-input').value;
            if (!val) return;
            document.getElementById('creation-input').disabled = true;
            document.getElementById('input-status').innerText = "Enviado! Aguardando outros...";
            if (isHost) {
                const p = players.find(p => p.id === myId);
                p.creation = val;
                checkAllSubmissions();
            } else { hostConn.send({ type: 'SUBMIT_CREATION', content: val }); }
        }

        // --- SISTEMA DE BATALHA ---
        function startTournament() {
            currentRound = [...players];
            currentRound.sort(() => Math.random() - 0.5);
            eliminatedPlayers = [];
            battleHistoryLog = [];
            generateBattles();
        }

        function generateBattles() {
            battleQueue = [];
            for (let i = 0; i < currentRound.length; i += 2) {
                if (i + 1 < currentRound.length) {
                    battleQueue.push({ p1: currentRound[i], p2: currentRound[i+1] });
                } else {
                    battleQueue.push({ p1: currentRound[i], p2: null });
                }
            }
            currentRound = []; 
            nextBattle();
        }

        function nextBattle() {
            if (battleQueue.length === 0) {
                if (currentRound.length === 1) {
                    const champ = currentRound[0];
                    const champData = { name: champ.name, creation: champ.creation };
                    broadcast({ type: 'SHOW_CHAMPION', p: champData });
                    showChampion(champData.name, champData.creation);
                    generateVictorySpeech(champ.name, champ.creation);
                    return;
                }
                generateBattles();
                return;
            }

            const battle = battleQueue.shift();
            
            if (!battle.p2) {
                currentRound.push(battle.p1);
                nextBattle(); 
                return;
            }

            const battleData = { 
                p1: { id: battle.p1.id, name: battle.p1.name, creation: battle.p1.creation }, 
                p2: { id: battle.p2.id, name: battle.p2.name, creation: battle.p2.creation } 
            };
            broadcast({ type: 'SHOW_BATTLE', data: battleData });
            showBattleUI(battleData);
            
            callOpenRouterAPI(battle.p1, battle.p2);
        }

        // --- SISTEMA DE REA√á√ïES ---
        function sendReaction(kind) {
            if (isHost) { spawnReaction(kind); broadcast({ type: 'SPAWN_REACTION', kind: kind }); } 
            else { hostConn.send({ type: 'REACTION', kind: kind }); }
        }
        function spawnReaction(kind) {
            const container = document.getElementById('reaction-layer');
            if (kind === 'tomato') {
                const img = document.createElement('img');
                const gifUrl = TOMATO_GIFS[Math.floor(Math.random() * TOMATO_GIFS.length)];
                img.src = `${gifUrl}?t=${Date.now()}`; 
                img.className = 'flying-tomato';
                img.style.left = (Math.random() * 20) + '%'; img.style.top = (Math.random() * 20) + '%';
                if (Math.random() > 0.5) img.style.transform = 'scaleX(-1)';
                container.appendChild(img);
                setTimeout(() => img.remove(), 7000);
            } else if (kind === 'fire') {
                const el = document.createElement('div');
                el.innerText = "üî•"; el.className = 'flying-fire';
                el.style.left = Math.random() * 90 + '%'; el.style.bottom = '0px';
                container.appendChild(el);
                setTimeout(() => el.remove(), 2000);
            }
        }
        
        function titleCase(str) {
            const ignore = ['de', 'da', 'do', 'das', 'dos', 'e', 'a', 'o', 'as', 'os', 'em', 'na', 'no', 'nas', 'nos', 'para', 'por', 'com', 'um', 'uma', 'uns', 'umas'];
            return str.toLowerCase().split(' ').map((word, i) => {
                if (i === 0 || !ignore.includes(word)) return word.charAt(0).toUpperCase() + word.slice(1);
                return word;
            }).join(' ');
        }

        // --- IA via OpenRouter ---
        async function callOpenRouterAPI(player1, player2) {
            document.getElementById('loading-ai').classList.remove('hidden');
            document.getElementById('battle-result').classList.add('hidden');
            
            const apiKey = OPENROUTER_API_KEY;
            const c1 = titleCase(player1.creation);
            const c2 = titleCase(player2.creation);

            const systemPrompt = `Role: Voc√™ √© o Juiz Gen-Z da "Rinha de Cria√ß√µes". Sua personalidade √© de um usu√°rio "cronicamente online" do Twitter: √°cido, sarc√°stico, levemente "woke", mas com humor negro e refer√™ncias pop/memes brasileiros atuais.

Diretrizes:
1. L√≥gica do Caos: O vencedor n√£o √© o mais forte, mas o que gera a cena mais engra√ßada ou absurda.
2. Identifica√ß√£o de Jogador: Se o item for "eu", "meu bra√ßo", etc., quebre a quarta parede e zoe (ou exalte) o jogador diretamente.
3. Refer√™ncias: Tente conectar os itens a memes, m√∫sicas (pagode, funk, pop) ou subcelebridades se o contexto permitir.
4. Estilo: N√£o use hashtags. N√£o comece frases com "Porque". Seja direto e ca√≥tico.

Formato de Sa√≠da (JSON Obrigat√≥rio):
{
  "winner_name": "The exact name of the winner (PlayerName1 or PlayerName2)",
  "winner_id": 1,
  "reason": "<string curta, max 5 sentences, descrevendo a fatalidade ou a humilha√ß√£o>"
}
CRITICAL: The 'winner_name' must be EXACTLY one of the two fighter names provided.`;

            const userPromptContent = `Batalha:
ID 1: "${player1.name}" usando "${c1}"
ID 2: "${player2.name}" usando "${c2}"

Quem vence?`;

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}`, "HTTP-Referer": window.location.href, "X-Title": "Munera Woke" },
                    body: JSON.stringify({ model: "xiaomi/mimo-v2-flash:free", messages: [{ role: "system", content: systemPrompt }, { role: "user", content: userPromptContent }], temperature: 0.8, max_tokens: 400 })
                });

                if (!response.ok) throw new Error(`OpenRouter API Error`);
                const data = await response.json();
                let contentText = data.choices[0].message.content.replace(/```json/g, "").replace(/```/g, "").trim();
                let result = JSON.parse(contentText);

                // --- L√ìGICA DE CORRE√á√ÉO DE VENCEDOR POR NOME ---
                const p1Name = player1.name.trim().toLowerCase();
                const p2Name = player2.name.trim().toLowerCase();
                // Tenta pegar o nome retornado pela IA, se existir
                const aiWinnerName = (result.winner_name || "").trim().toLowerCase();

                let winner, loser;

                // 1. Tenta casar pelo nome (Mais confi√°vel se a IA descreve o vencedor)
                if (aiWinnerName.includes(p1Name) || aiWinnerName === p1Name) {
                    winner = player1;
                    loser = player2;
                } else if (aiWinnerName.includes(p2Name) || aiWinnerName === p2Name) {
                    winner = player2;
                    loser = player1;
                } else {
                    // 2. Fallback para ID se o nome falhar ou n√£o vier
                    const idWin = result.winner_id;
                    if (idWin == 1 || idWin == "1") {
                        winner = player1;
                        loser = player2;
                    } else {
                        winner = player2;
                        loser = player1;
                    }
                }
                
                const winnerCreationTitle = titleCase(winner.creation);
                
                currentRound.push(winner);
                eliminatedPlayers.push(loser);
                
                battleHistoryLog.push({
                    p1: player1.name, c1: c1,
                    p2: player2.name, c2: c2,
                    winner: winner.name, reason: result.reason
                });

                const resData = { 
                    winnerName: winnerCreationTitle, 
                    reason: result.reason, 
                    winnerId: winner.id, 
                    loserId: loser.id 
                };
                
                broadcast({ type: 'SHOW_RESULT', data: resData });
                showResultUI(resData);

            } catch (error) {
                console.error(error);
                currentRound.push(player1); eliminatedPlayers.push(player2);
                const resData = { winnerName: titleCase(player1.creation), reason: "A IA foi cancelada no Twitter. W.O.!", winnerId: player1.id, loserId: player2.id };
                broadcast({ type: 'SHOW_RESULT', data: resData });
                showResultUI(resData);
            }
        }

        async function generateVictorySpeech(championName, championCreation) {
            const apiKey = OPENROUTER_API_KEY;
            const prompt = `
Voc√™ √© "${championCreation}".
Finja ser "${championCreation}" e fale algo engra√ßado.
Mesmo que seja um conceito ou at√© um objeto, FINJA SER ISSO.
Voc√™ n√£o explica o que √©, voc√™ simplesmente √â.
Seja curto, m√°ximo 2-3 frases, cheio de sarcasmo, humor e refer√™ncias diretas ou indiretas a "${championCreation}".
Tente imaginar a personalidade do(a) "${championCreation}" e use ela, da melhor forma poss√≠vel. √â a sua personalidade.
Seja sempre imprevis√≠vel.
N√£o aja como se voc√™ estivesse fazendo uma piada com o nome, porque VOC√ä √© o nome.
N√£o use hashtags.
V√° direto ao ponto.
M√°ximo 2-3 frases.

Exemplo:
Se voc√™ for "Toon Force", um discurso poderia ser:
"*Puxa um martelo comicamente gigante* L√≥gica? F√≠sica? Eu n√£o sei o que √© isso. Isso √© tudo p-pessoal!"

Agora, gere a mensagem fingindo ser "${championCreation}":
`;
            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}`, "HTTP-Referer": window.location.href, "X-Title": "Munera Woke" },
                    body: JSON.stringify({ model: "xiaomi/mimo-v2-flash:free", messages: [{ role: "user", content: prompt }], temperature: 0.8, max_tokens: 300 })
                });
                const data = await response.json();
                const speechText = data.choices[0].message.content.trim();
                broadcast({ type: 'UPDATE_SPEECH', speech: speechText });
                updateChampionSpeech(speechText);
            } catch (error) {
                const fallbackSpeech = "Eu venci e nem sei o que dizer... #bug";
                broadcast({ type: 'UPDATE_SPEECH', speech: fallbackSpeech });
                updateChampionSpeech(fallbackSpeech);
            }
        }

        // --- UI E REDE ---
        function broadcast(msg) {
            connections.forEach(c => c.send(msg));
        }

        function showBattleUI(data) {
            showScreen('battle');
            playSound('start');
            document.getElementById('p1-name').innerText = data.p1.name;
            document.getElementById('p1-creation').innerText = data.p1.creation;
            document.getElementById('p2-name').innerText = data.p2.name;
            document.getElementById('p2-creation').innerText = data.p2.creation;
            document.getElementById('loading-ai').classList.remove('hidden');
            document.getElementById('battle-result').classList.add('hidden');
            document.getElementById('next-btn').classList.add('hidden');
        }

        function showResultUI(data) {
            playSound('win');
            document.getElementById('loading-ai').classList.add('hidden');
            document.getElementById('battle-result').classList.remove('hidden');
            document.getElementById('winner-name').innerText = data.winnerName;
            
            typeWriter('ai-reason', data.reason, 30); 
            
            if (myId === data.loserId) { isSpectator = true; document.getElementById('spectator-controls').classList.remove('hidden'); }

            if (isHost) {
                const btn = document.getElementById('next-btn');
                btn.classList.remove('hidden');
                
                if (battleQueue.length === 0) {
                    if (currentRound.length === 1) { btn.innerText = "TERMINAR BATALHA"; } 
                    else { btn.innerText = "PR√ìXIMA RODADA"; }
                } else { btn.innerText = "PR√ìXIMA BATALHA"; }
            }
        }
        
        function showChampion(name, creation) {
            playSound('win');
            showScreen('champion');
            document.getElementById('final-creation').innerText = creation;
            document.getElementById('champion-speech').innerText = "...";
            document.getElementById('champion-speech').classList.add("typing-cursor");
            document.getElementById('spectator-controls').classList.add('hidden'); 
            
            // Bot√£o "VER PLACAR" apenas para Host
            if (isHost) {
                document.getElementById('btn-show-recap').classList.remove('hidden');
                document.getElementById('msg-wait-recap').classList.add('hidden');
            } else {
                document.getElementById('btn-show-recap').classList.add('hidden');
                document.getElementById('msg-wait-recap').classList.remove('hidden');
            }
        }

        function updateChampionSpeech(speech) {
            if (speech) { typeWriter('champion-speech', `"${speech}"`, 40); } 
            else { document.getElementById('champion-speech').innerText = "..."; }
        }

        // --- SISTEMA DE PLACAR E RECAP ---
        function hostTriggerRecap() {
            // Apenas host chama isso. Prepara dados e manda para todos.
            // Precisamos montar os dados do podium e log aqui
            const first = currentRound[0];
            const second = eliminatedPlayers[eliminatedPlayers.length - 1]; 
            const third = eliminatedPlayers[eliminatedPlayers.length - 2]; 
            
            const podiumData = {
                first: first ? first.name : null,
                second: second ? second.name : null,
                third: third ? third.name : null
            };

            const logData = battleHistoryLog; // Log completo do host

            broadcast({ type: 'SHOW_RECAP', podium: podiumData, log: logData });
            renderRecapScreen(podiumData, logData);
        }

        function renderRecapScreen(podiumData, logData) {
            showScreen('recap');
            
            // Render Podium
            const podium = document.getElementById('podium-area');
            podium.innerHTML = "";
            if (podiumData.second) podium.innerHTML += `<div class="podium-place rank-2"><div class="podium-rank">2¬∫</div><div class="podium-name">${podiumData.second}</div></div>`;
            if (podiumData.first) podium.innerHTML += `<div class="podium-place rank-1"><div class="podium-rank">1¬∫</div><div class="podium-name">${podiumData.first}</div></div>`;
            if (podiumData.third) podium.innerHTML += `<div class="podium-place rank-3"><div class="podium-rank">3¬∫</div><div class="podium-name">${podiumData.third}</div></div>`;

            // Render Log (Completo)
            const container = document.getElementById('battle-log-container');
            container.innerHTML = "";
            logData.forEach((log, index) => {
                container.innerHTML += `
                    <div class="log-entry">
                        <strong style="color:#ffcc00">Batalha ${index + 1}:</strong> ${log.p1} (${log.c1}) vs ${log.p2} (${log.c2})<br>
                        <span style="color:#00ff00">Vencedor: ${log.winner}</span> - <i>"${log.reason}"</i>
                    </div>`;
            });

            // Configura√ß√£o do bot√£o de rematch
            const btnRematch = document.getElementById('btn-rematch');
            const statusTxt = document.getElementById('rematch-status');
            btnRematch.disabled = false;
            btnRematch.style.background = "#ffcc00";
            btnRematch.innerText = "JOGAR NOVAMENTE";
            statusTxt.innerText = "";

            if (isHost) {
                document.getElementById('btn-host-end').classList.remove('hidden');
                // Host come√ßa desabilitado at√© todos clientes darem ready
                btnRematch.disabled = true;
                btnRematch.style.background = "#555";
                btnRematch.innerText = "JOGAR NOVAMENTE";
                statusTxt.innerText = `Aguardando jogadores... (0/${players.length - 1})`;
            }
        }

        // --- SISTEMA DE REVANCHE E FIM ---
        function hostEndGame() {
            broadcast({ type: 'HOST_ENDED' });
            location.reload(); 
        }

        function handleRematchClick() {
            const btn = document.getElementById('btn-rematch');
            btn.disabled = true;
            btn.style.background = "#555";

            if (isHost) {
                // Host clicou para INICIAR (s√≥ libera se todos estiverem prontos, ver handleClientRematch)
                // Se o bot√£o estava habilitado pro host, √© porque todos est√£o prontos.
                startRematchCountdown();
            } else {
                // Cliente clicou para dizer que est√° pronto
                btn.innerText = "Aguardando Host...";
                hostConn.send({ type: 'CLIENT_REMATCH' });
            }
        }

        function handleClientRematch(peerId) {
            if (!isHost) return;
            rematchReadyCount++;
            const totalClients = players.length - 1; // Exclui host
            
            const btn = document.getElementById('btn-rematch');
            const statusTxt = document.getElementById('rematch-status');
            statusTxt.innerText = `Aguardando jogadores... (${rematchReadyCount}/${totalClients})`;

            if (rematchReadyCount >= totalClients) {
                // Todos clientes prontos, libera bot√£o pro host
                btn.disabled = false;
                btn.style.background = "#ffcc00";
                btn.innerText = "INICIAR REVANCHE";
                statusTxt.innerText = "Todos prontos! Clique para iniciar.";
            }
        }

        function startRematchCountdown() {
            const btn = document.getElementById('btn-rematch');
            btn.disabled = true;
            let seconds = 3;
            btn.innerText = `Iniciando em ${seconds}...`;
            
            const timer = setInterval(() => {
                seconds--;
                btn.innerText = `Iniciando em ${seconds}...`;
                if (seconds <= 0) {
                    clearInterval(timer);
                    broadcast({ type: 'RESET_GAME' });
                    resetLocalGame();
                }
            }, 1000);
        }

        function resetLocalGame() {
            players.forEach(p => { p.creation = ""; p.isReady = false; });
            battleQueue = [];
            currentRound = [];
            eliminatedPlayers = [];
            battleHistoryLog = [];
            rematchReadyCount = 0;
            isSpectator = false;
            
            // UI Reset
            document.getElementById('creation-input').disabled = false;
            document.getElementById('creation-input').value = "";
            document.getElementById('input-status').innerText = "";
            document.getElementById('spectator-controls').classList.add('hidden');

            performStartSequence(currentTheme); 
        }

    </script>
</body>
</html>
